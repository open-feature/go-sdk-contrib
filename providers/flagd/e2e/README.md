# flagd Provider E2E Test Infrastructure

This directory contains end-to-end tests for the flagd OpenFeature provider, using the official flagd testbed for comprehensive integration testing.

## Architecture Overview

### Test Structure
- **Step Definitions**: Located in `../../tests/flagd/pkg/integration/` - reusable Gherkin step implementations
- **Test Runners**: Located in `./` - provider-specific test implementations that use the step definitions
- **Gherkin Features**: Located in `./flagd-testbed/gherkin/` - official test scenarios from flagd testbed

### Container-Based Testing
All tests use the `ghcr.io/open-feature/flagd-testbed` container which includes:
- **flagd server** - The actual flagd implementation
- **Launchpad API** - Test control interface for managing flagd lifecycle and configuration
- **Test Data** - Pre-configured flag definitions for various test scenarios

## Provider Types and Configuration

### RPC Provider (`rpc_test.go`)
Tests the gRPC-based flag evaluation.
- **Connection**: Direct gRPC connection to flagd server in container
- **Port**: Uses container's RPC port (8013 internally, mapped externally)
- **Features**: Full evaluation, caching, streaming updates

### InProcess Provider (`inprocess_test.go`)
Tests the in-process flag evaluation using flagd as a library.
- **Connection**: HTTP connection to flagd's sync endpoints
- **Port**: Uses container's in-process port (8015 internally, mapped externally)
- **Features**: Local evaluation, sync from flagd, context enrichment

### File Provider (`file_test.go`)
Tests offline file-based flag evaluation.
- **File Source**: Uses `allFlags.json` generated by launchpad
- **Volume Mount**: Local temp directory mounted as `/flags` in container
- **Data Flow**:
  1. Container starts and mounts local directory to `/flags`
  2. Launchpad generates `allFlags.json` at `/flags/allFlags.json` (inside container)
  3. File appears in local temp directory due to volume mount
  4. Provider reads from local path `tempDir/allFlags.json`

### Configuration Provider (`config_test.go`)
Tests provider configuration validation and defaults.
- **Scope**: Configuration parsing, option validation, environment variables
- **No Container**: Uses direct configuration testing without flagd server

## Step Definitions Architecture

Located in `../../tests/flagd/pkg/integration/`, organized by concern:

### Core Files
- **`types.go`** - All type definitions (TestState, ProviderType, EventRecord, etc.)
- **`utils.go`** - Centralized value conversion and utility functions
- **`step_definitions.go`** - Main scenario initialization and test state management

### Step Implementation Files
- **`config_steps.go`** - Provider configuration testing steps
- **`provider_steps.go`** - Provider lifecycle management (create, ready, error states)
- **`flag_steps.go`** - Flag evaluation steps (evaluate, assert values, reasons, variants)
- **`context_steps.go`** - Evaluation context management steps
- **`event_steps.go`** - Provider event handling steps (ready, error, stale, config change)
- **`testcontainer.go`** - Container management and launchpad integration

### Key Features
- **Centralized Types**: All types consolidated for consistency
- **Reusable Components**: Step definitions work across all provider types
- **Provider Abstraction**: Tests work with RPC, InProcess, and File providers
- **Event Testing**: Comprehensive event lifecycle testing
- **Configuration Testing**: Thorough option validation and defaults

## Test Status Matrix

| Test Suite | Provider Type | Status | Test Count | Notes |
|------------|---------------|---------|------------|-------|
| **Configuration** | N/A (Direct) | ✅ **PASS** | ~15 scenarios | Configuration validation working perfectly |
| **RPC Provider** | gRPC | ❌ **TIMEOUT** | ~50+ scenarios | Connection/timeout issues, needs investigation |
| **InProcess Provider** | HTTP Sync | ❌ **FAIL** | ~40+ scenarios | Connection/sync issues, needs investigation |  
| **File Provider** | Offline Files | ⚠️ **PARTIAL** | ~20+ scenarios | Basic tests pass, file sync issues remain |

### Detailed Status

#### ✅ Configuration Tests (`config_test.go`)
- **Status**: All passing reliably
- **Coverage**: Provider options, environment variables, validation
- **Scenarios**: Default configs, custom configs, error conditions

#### ❌ RPC Provider Tests (`rpc_test.go`) 
- **Status**: Timing out after 30s
- **Issues**: Container connectivity, gRPC connection establishment
- **Filtered Tags**: Excludes `@reconnect`, `@events`, `@grace`, `@sync`, `@metadata`
- **Next Steps**: Investigate container network configuration

#### ❌ InProcess Provider Tests (`inprocess_test.go`)
- **Status**: Failing due to sync issues  
- **Issues**: HTTP sync connectivity, provider initialization
- **Filtered Tags**: Excludes `@grace`, `@reconnect`, `@events`, `@sync`
- **Next Steps**: Debug HTTP sync configuration

#### ⚠️ File Provider Tests (`file_test.go`)
- **Status**: Mixed results - basic tests pass, sync issues with file watching
- **Issues**: `allFlags.json` file deletion/recreation during test execution
- **Architecture**: Volume mount working, launchpad file generation working
- **Filtered Tags**: Excludes `@reconnect`, `@sync`, `@grace`, `@events`
- **Next Steps**: Investigate file watching and deletion patterns

## Tag Filtering Strategy

Tests use Gherkin tags to control which scenarios run for each provider type:

### Common Exclusions
- `@reconnect` - Connection recovery scenarios (complex, connection-dependent)
- `@events` - Provider event scenarios (complex state management)
- `@grace` - Graceful degradation scenarios (advanced error handling)
- `@sync` - Synchronization scenarios (requires stable connections)

### Provider-Specific Tags
- `@rpc` - RPC provider specific scenarios
- `@in-process` - InProcess provider scenarios  
- `@file` - File provider scenarios
- `@targeting` - Flag targeting scenarios
- `@caching` - Flag caching scenarios
- `@metadata` - Metadata scenarios

## Running Tests

### Individual Test Suites
```bash
# Configuration tests (always reliable)
go test -v ./e2e/config_test.go ./e2e/testbed_runner.go -timeout=1m

# RPC provider tests
go test -v ./e2e/rpc_test.go ./e2e/testbed_runner.go -timeout=5m

# InProcess provider tests  
go test -v ./e2e/inprocess_test.go ./e2e/testbed_runner.go -timeout=5m

# File provider tests
go test -v ./e2e/file_test.go ./e2e/testbed_runner.go -timeout=5m
```

### All Tests
```bash
go test -v ./e2e/... -timeout=10m
```

## Development Workflow

### Adding New Step Definitions
1. Add step implementation to appropriate file in `../../tests/flagd/pkg/integration/`
2. Register step in `InitializeScenario` function
3. Update types in `types.go` if needed
4. Use centralized utilities from `utils.go`

### Adding New Provider Tests
1. Create new `*_test.go` file in this directory
2. Use `NewTestbedRunner` with appropriate `TestbedConfig`
3. Call `RunGherkinTestsWithSubtests` with relevant tag filters
4. Update this README with test status

### Debugging Failed Tests
1. Check container logs: Look for flagd startup issues
2. Verify network connectivity: Ensure ports are accessible
3. Check file mounts: For file provider, verify volume mounts work
4. Review tag filtering: Ensure appropriate scenarios are included/excluded
5. Test individual scenarios: Use godog CLI for specific scenario testing

## Future Improvements

### Short Term
- Fix RPC provider connection issues
- Resolve InProcess provider sync problems  
- Stabilize File provider file watching
- Add more comprehensive error testing

### Long Term
- Add performance testing scenarios
- Implement chaos testing (network failures, restarts)
- Add metrics and observability testing
- Expand configuration testing coverage
- Add multi-provider concurrent testing

## Architecture Benefits

- **Separation of Concerns**: Test logic separated from step definitions
- **Reusability**: Steps work across all provider types
- **Maintainability**: Centralized types and utilities
- **Official Compliance**: Uses official flagd testbed scenarios
- **Realistic Testing**: Tests against actual flagd container
- **Easy Debugging**: Clear separation makes issues easier to isolate